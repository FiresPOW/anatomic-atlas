server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Включаем сжатие gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Логирование для отладки
    error_log /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log;

    # Обслуживание статических файлов и основного сайта
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Особая обработка для CloudFront (Sketchfab использует его)
    location ~ ^/proxy/https://static\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8;
        proxy_pass https://static.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host static.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_buffering off;
    }

    # Особая обработка для API Sketchfab
    location ~ ^/proxy/https://api\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8;
        proxy_pass https://api.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host api.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_buffering off;
    }

    # Общая обработка для Sketchfab
    location ~ ^/proxy/https://sketchfab\.com/(.*)$ {
        resolver 8.8.8.8;
        proxy_pass https://sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_buffering off;
    }

        # Обработка для media.sketchfab.com
    location ~ ^/proxy/https://media\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8;
        proxy_pass https://media.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host media.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "image/webp,image/apng,image/*,*/*;q=0.8";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        
        # Увеличиваем таймауты для больших файлов
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Настройки кэширования для медиа
        proxy_buffering on;
        proxy_cache sketchfab_cache;
        proxy_cache_valid 200 7d;
        expires 7d;
    }

    # Общий прокси для других доменов
    location ~ ^/proxy/(https?):/([^/]+)/(.*)$ {
        resolver 8.8.8.8;
        set $proto $1;
        set $domain $2;
        proxy_pass $proto://$domain/$3$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host $domain;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_buffering off;
    }
}