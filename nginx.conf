server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Увеличенные таймауты и буферы
    client_max_body_size 50M;
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Включаем сжатие gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Более детальное логирование для отладки
    error_log /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log;

    # Обслуживание статических файлов и основного сайта
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Особая обработка для static.sketchfab.com
    location ~ ^/proxy/https://static\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass https://static.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host static.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    # Особая обработка для API Sketchfab
    location ~ ^/proxy/https://api\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass https://api.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host api.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_buffering off;
    }

    # Общая обработка для Sketchfab
    location ~ ^/proxy/https://sketchfab\.com/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass https://sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_buffering off;
    }

    # ИСПРАВЛЕНО: Обработка для media.sketchfab.com
    location ~ ^/proxy/https://media\.sketchfab\.com/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass https://media.sketchfab.com/$1$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host media.sketchfab.com;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "image/webp,image/apng,image/*,*/*;q=0.8";
        proxy_set_header Accept-Language "en-US,en;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        
        # Увеличиваем таймауты для больших файлов
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
    }

    # ИСПРАВЛЕНО: Прямой проксирующий маршрут с поддержкой полных URL
    location ~ ^/direct-proxy/https://([^/]+)/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass https://$1/$2$is_args$args;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;  # Отключаем проверку SSL для обхода проблем с сертификатами
        
        # Точные заголовки из curl команды
        proxy_set_header Host $1;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 YaBrowser/25.2.0.0 Safari/537.36";
        proxy_set_header Accept "text/css,*/*;q=0.1";
        proxy_set_header Accept-Language "en,ru;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_set_header DNT "1";
        proxy_set_header sec-ch-ua "\"Not A(Brand\";v=\"8\", \"Chromium\";v=\"132\", \"YaBrowser\";v=\"25.2\", \"Yowser\";v=\"2.5\"";
        proxy_set_header sec-ch-ua-mobile "?0";
        proxy_set_header sec-ch-ua-platform "\"macOS\"";
        proxy_set_header sec-fetch-dest "style";
        proxy_set_header sec-fetch-mode "cors";
        proxy_set_header sec-fetch-site "same-site";
        
        # Увеличенные таймауты
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_buffering off;
    }

    # Тот же маршрут для HTTP
    location ~ ^/direct-proxy/http://([^/]+)/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        proxy_pass http://$1/$2$is_args$args;
        proxy_ssl_server_name on;
        
        # Та же конфигурация заголовков
        proxy_set_header Host $1;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 YaBrowser/25.2.0.0 Safari/537.36";
        proxy_set_header Accept "text/css,*/*;q=0.1";
        proxy_set_header Accept-Language "en,ru;q=0.9";
        proxy_set_header Origin "https://sketchfab.com";
        proxy_set_header Referer "https://sketchfab.com/";
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_buffering off;
    }


    # Общий прокси для других доменов (ИСПРАВЛЕН)
    location ~ ^/proxy/(https?):/([^/]+)/(.*)$ {
        resolver 8.8.8.8 ipv6=off;
        set $proto $1;
        set $domain $2;
        proxy_pass $proto://$domain/$3$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host $domain;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }
}